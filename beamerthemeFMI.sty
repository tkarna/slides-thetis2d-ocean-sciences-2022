%% Beamer theme for FMI slide presentations
%%
%% Version: 2019-03-29
%% marko.laine@fmi.fi

\mode<presentation>

\institute[FMI]{Finnish Meteorological Institute} % Default institute

% start from the default beamer themes
\useinnertheme{default}
\useoutertheme{default}
\usecolortheme{default}

%% FMI colors
\definecolor{fmiblue}{RGB}{48,49,147}
\definecolor{fmilightblue}{RGB}{58,102,227}
\definecolor{fmiturquoise}{RGB}{2,184,206}
\definecolor{fmigreen}{RGB}{82,193,161}
\definecolor{fmiblack}{RGB}{0,0,0}
\definecolor{fmiwhite}{RGB}{255,255,255}

%% Color definitions
\setbeamercolor{normal text}{fg=black, bg=white!20}
\setbeamercolor{alerted text}{fg=red}
\setbeamercolor{example text}{fg=green!50!black}
\setbeamercolor{background canvas}{bg=}
%\setbeamercolor{background canvas}{bg=fmilightblue, fg=fmiwhite}
\setbeamercolor{background}{parent=background canvas}
\setbeamercolor{title page background canvas}{bg=fmiblue, fg=fmiwhite}
\setbeamercolor{title page title}{fg=fmiwhite, bg=}
\setbeamercolor{title}{fg=fmiblue, bg=}
\setbeamercolor{frametitle}{fg=fmiblue, bg=}
\setbeamercolor{headline}{parent=background canvas}
\setbeamercolor{footline}{parent=background canvas}

\setbeamertemplate{navigation symbols}{}
\setbeamertemplate{itemize items}[circle]

\defbeamertemplate{footline}{title slide}{}

\newlength{\marginskip}\setlength{\marginskip}{0cm}
\defbeamertemplate{footline}{empty}{}
\defbeamertemplate{footline}{plain}{%
  \begin{beamercolorbox}[wd=\textwidth, sep=3ex]{footline}%
  %  \usebeamerfont{page number in head/foot}%
    \hfill\insertframenumber\ / \inserttotalframenumber\hspace*{\marginskip}
  \end{beamercolorbox}%
}

\defbeamertemplate{footline}{verbose}{%
   \begin{beamercolorbox}[wd=\textwidth, sep=3ex]{footline}%
     \hfill%
     \insertshortauthor:\ \insertshorttitle \hspace{0.5cm}%
     \insertframenumber\ / \inserttotalframenumber\hspace*{\marginskip}
   \end{beamercolorbox}%
}

\defbeamertemplate{footline}{numberonly}{%
  \begin{beamercolorbox}[wd=\textwidth, sep=3ex]{footline}%
    \hfill\insertframenumber\hspace*{\marginskip}
  \end{beamercolorbox}%
}

% empty all sidebars
\setbeamertemplate{sidebar right}{}
\setbeamertemplate{sidebar left}{}

\defbeamertemplate{background canvas}{FMIdefault}{} % empty now
\defbeamertemplate{background canvas}{empty}{} % empty bg
\defbeamertemplate{background}{empty}{} % empty bg

\defbeamertemplate{background}{FMIlogo}{%
  \vbox to \paperheight{\vfil\hspace{0.4cm}\insertlogo\vspace{0.4cm}}
}
% both logo and blue pattern (but how to set the margins)
\defbeamertemplate{background}{FMIpattern}{%
  \hbox to \paperwidth{%
    \vbox to \paperheight{\vfil\hspace{0.4cm}\insertlogo\vspace{0.4cm}}%
    \hfill\pgfuseimage{fmipatternblue}}
}

% default to have a logo
\setbeamertemplate{background}[FMIlogo]%
%\setbeamertemplate{footline}[numberonly]
\setbeamertemplate{footline}[verbose]

%\BeforeBeginEnvironment{frame}{%
%%  \setbeamertemplate{background canvas}[FMIdefault]%
%%  \setbeamertemplate{background}[FMIlogo]%
%}

% define custom frames
\define@key{beamerframe}{titlepage}[true]{%
  \setbeamertemplate{background}[default]%
  \setbeamertemplate{background canvas}[default]%
  \setbeamercolor{background canvas}{use=title page background canvas,bg=title page background canvas.bg}
  \logo{\pgfuseimage{fmi-logo-white-bigger}}
  \setbeamertemplate{footline}{}%
  \setbeamertemplate{headline}{}%
  \addtobeamertemplate{background}{}{
    \hbox to \paperwidth{\hfill\pgfuseimage{fmipatternwhite}}
  }
  \addtolength{\textwidth}{-2cm}
}

% Title page generated by \maketitle
\setbeamertemplate{title page}{
  \begin{minipage}[b][\paperheight]{\textwidth}
    \vspace*{2.5cm}
    {\usebeamercolor[fg]{title page title}
      \begin{flushleft}%
        {\huge\textbf{\inserttitle}}\\%[4mm]
        \ifx\insertsubtitle\@empty\vskip 4mm\else\vskip 2mm\insertsubtitle\\[2mm]\fi
        \insertauthor\\
        \insertinstitute\\
        \insertdate\\
        \inserttitlegraphic
      \end{flushleft}%
    }
    \vfill
    \hspace{-2mm}
    \pgfuseimage{fmi-logo-white-bigger}
    \vspace*{0.8cm}
\end{minipage}
}

\def\titlepage{\usebeamertemplate{title page}}
\def\maketitle{%
  \ifbeamer@inframe
  {\titlepage}
  \else
%  {\frame[plain,noframenumbering,titlepage]{\titlepage}}
  {\frame[plain,titlepage]{\titlepage}}
  \fi
}

\define@key{beamerframe}{empty}[true]{%
%  \setbeamertemplate{background canvas}[default]%
  \setbeamertemplate{background canvas}[empty]%
  \setbeamertemplate{background}[empty]%
  \setbeamertemplate{footline}{}%
  \setbeamertemplate{headline}{}%
}

% fmi patterns on right
\define@key{beamerframe}{FMIpattern}[true]{%
  \addtolength{\textwidth}{-2cm} % does not work without minipage
  \setlength{\marginskip}{2cm} % to move the footnote
  \setbeamertemplate{background}[FMIpattern]%
}

\setbeamertemplate{frametitle}[default][left]
% Raise the title a little
%\addtobeamertemplate{frametitle}{\vskip-1.3ex}{}

%% margins (not to overlap the graphics on right)
%\setbeamersize{text margin right=4cm}

\setbeamertemplate{frametitle}
{
  \ifbeamercolorempty[bg]{frametitle}{}{\nointerlineskip}%
  \@tempdima=\textwidth%
  \advance\@tempdima by\beamer@leftmargin%
  \advance\@tempdima by\beamer@rightmargin%
  \begin{beamercolorbox}[sep=0.3cm,left,wd=\the\@tempdima]{frametitle}
    \vbox{}\vskip-1ex%
    \if@tempswa\else\csname beamer@fteleft\endcsname\fi%
    {\strut\usebeamercolor[fg]{frametitle}%
      \bfseries\insertframetitle\strut\par%
    {%
      \ifx\insertframesubtitle\@empty%
      \else%
      {\usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle\strut\par}%
      \fi
    }%
 %   \vskip-1.5ex%
 %   \rule{\dimexpr\paperwidth-0.6cm\relax}{0.4pt}
  }
    \if@tempswa\else\vskip-.3cm\fi% set inside beamercolorbox... evil here...
  \end{beamercolorbox}%
    %
}

%% backgound macros
% final page
\newcommand{\bgfinal}{
  \setbeamertemplate{footline}{}
  \setbeamertemplate{headline}{}
  \setbeamertemplate{background}[default]%
  \setbeamertemplate{background canvas}[default]%
  \setbeamercolor{background canvas}{use=title page background canvas,bg=title page background canvas.bg,fg=title page background canvas.fg}
  \logo{\pgfuseimage{fmi-logo-white-bigger}}
  \usebeamercolor[fg]{title page title}

  \addtobeamertemplate{background}{}{
    \hbox to \paperwidth{\hfill\pgfuseimage{fmipatternwhite}}
  }
  \addtolength{\textwidth}{-2.5cm}

}
% empty page
\newcommand{\bgempty}{
  \setbeamertemplate{background}[empty]%
  \setbeamertemplate{background canvas}{}
  \setbeamertemplate{footline}{}
  \setbeamertemplate{headline}{}
}

\newcommand{\bgfmi}{
  \setbeamertemplate{background}[FMIpattern]%
}

\newcommand{\bgrealempty}{
  \setbeamertemplate{background canvas}{}
  \setbeamertemplate{footline}{}
  \setbeamertemplate{headline}{}
}

%% define graphics elements
\pgfdeclareimage[height=0.6cm]{fmi-logo}{fig/il-logo-fi-se-en-rgb-blue}
\pgfdeclareimage[height=0.8cm]{fmi-logo-bigger}{fig/il-logo-fi-se-en-rgb-blue}
\pgfdeclareimage[height=0.6cm]{fmi-logo-white}{fig/il-logo-fi-se-en-rgb-white}
\pgfdeclareimage[height=0.8cm]{fmi-logo-white-bigger}{fig/il-logo-fi-se-en-rgb-white}
\pgfdeclareimage[height=\paperheight]{fmipatternwhite}{fig/il-pattern-white}
\pgfdeclareimage[height=\paperheight]{fmipatternblue}{fig/il-pattern-blue}

\logo{\pgfuseimage{fmi-logo}}

\mode<all>
